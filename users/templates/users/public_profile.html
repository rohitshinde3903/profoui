{% extends 'users/base.html' %}
{% block title %}{{ user.username }}'s Public Profile | PROFO{% endblock %}
{% block content %}
{% load static %}

<div class="container py-5 fade-in">
    <div class="profile-container">
        <!-- Profile Header Card -->
        <div class="card profile-card mb-4">
            <div class="profile-cover-image position-relative">
                {% if user.intro_video %}
                    <video id="introVideo" class="profile-bg-video">
                        <source src="{{ user.intro_video.url }}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                    <button id="playPauseBtn" class="video-control-btn">
                        <i class="ph ph-play"></i>
                    </button>
                {% endif %}
            </div>
            <div class="card-body position-relative">
                {% if user.is_premium %}
                <div class="profile-badge">
                    <i class="ph ph-crown me-1"></i>Premium Member
                </div>
                {% endif %}

                <!-- Profile Picture Section -->
                <div class="profile-picture-section text-center">
                    <div class="profile-picture-wrapper">
                        {% if user.profile_picture %}
                            <img src="{{ user.profile_picture.url }}" alt="{{ user.username }}" class="profile-picture" data-bs-toggle="modal" data-bs-target="#profileImageModal">
                        {% else %}
                            <img src="{% static 'users/default/df.png' %}" alt="Default Profile" class="profile-picture">
                        {% endif %}
                    </div>

                    <h2 class="fw-bold text-primary mt-3">{{ user.username }}</h2>
                    {% if user.tagline %}
                        <p class="text-success fw-semibold">{{ user.tagline }}</p>
                    {% endif %}

                    {% if user.bio %}
                        <p class="text-muted">{{ user.bio }}</p>
                    {% endif %}

                    <!-- Stats Cards -->
                    <div class="stats-container">
                        <div class="stat-card">
                            <a href="{% url 'view_followers' user.username %}" style="text-decoration: none;">
                                <div class="stat-value" id="followers-btn">{{ user.followers.count }}</div>
                            </a>
                            <div class="stat-label">Followers</div>
                        </div>
                        <div class="stat-card">
                            <a href="{% url 'view_following' user.username %}" style="text-decoration: none;">
                                <div class="stat-value" id="following-btn">{{ user.following.count }}</div>
                            </a>
                            <div class="stat-label">Following</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">{{ user.social_links.count }}</div>
                            <div class="stat-label">Social Links</div>
                        </div>
                    </div>

                    <!-- Follow Button (only shown if viewing someone else's profile) -->
                    {% if request.user != user %}
                    <div class="action-buttons mt-4">
                        {% if user in request.user.following.all %}
                            <a href="{% url 'unfollow_user' user.id %}" class="btn btn-outline-danger">
                                <i class="ph ph-user-minus me-2"></i>Unfollow
                            </a>
                        {% else %}
                            <a href="{% url 'follow_user' user.id %}" class="btn btn-primary">
                                <i class="ph ph-user-plus me-2"></i>Follow
                            </a>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Resume Section -->
        {% if user.resume or user == request.user %}
        <div class="card feature-card mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="h5 fw-bold mb-0">
                        <i class="ph ph-file-text text-primary me-2"></i>Resume
                    </h3>
                    {% if user.resume %}
                        <a href="{{ user.resume.url }}" class="btn btn-outline-primary btn-sm" target="_blank">
                            <i class="ph ph-download me-2"></i>Download
                        </a>
                    {% endif %}
                </div>
                
                {% if user.resume %}
                    <div class="resume-preview">
                        <i class="ph ph-file-pdf text-primary"></i>
                        <span class="ms-2">resume.pdf</span>
                    </div>
                {% else %}
                    <p class="text-muted mb-0">No resume uploaded yet</p>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Social Links Section -->
        <div class="card feature-card mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="h5 fw-bold mb-0">
                        <i class="ph ph-share-network text-primary me-2"></i>Social Links
                    </h3>
                </div>

                <div class="social-links-grid">
                    {% for link in user.social_links.all %}
                        {% if not link.is_private or user == request.user %}
                            <div class="social-link-card">
                                <div class="platform-icon">
                                    <a href="{% url 'track_social_link' link.id %}" style="text-decoration:none" target="_blank">
                                        <img height="50" src="{% static 'users/icons/'|add:link.platform|add:'.png' %}" 
                                             onerror="this.onerror=null;this.src='{% static 'users/icons/website.png' %}';"
                                             alt="{{ link.platform }} icon" class="icon-img">
                                    </a>
                                </div>
                                <div class="link-details">
                                    <a href="{% url 'track_social_link' link.id %}" style="text-decoration:none" target="_blank">
                                        <h4 class="platform-name">{{ link.platform }}</h4>
                                    </a>
                                    <a href="{% url 'track_social_link' link.id %}" target="_blank" class="link-url">{{ link.url }}</a>
                                    <div class="link-stats">
                                        <span class="stats-item">
                                            <i class="ph ph-eye me-1"></i>{{ link.click_count }} views
                                        </span>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    {% empty %}
                        <p class="text-muted text-center mb-0">No social links added yet</p>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Career Growth Section -->
        {% if user.career_growth %}
        <div class="card feature-card mb-4">
            <div class="card-body">
                <h3 class="h5 fw-bold mb-3">
                    <i class="ph ph-trend-up text-primary me-2"></i>Career Growth Summary
                </h3>
                <p>{{ user.career_growth|linebreaksbr }}</p>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Profile Image Modal -->
<div class="modal fade" id="profileImageModal" tabindex="-1" aria-labelledby="profileImageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title" id="profileImageModalLabel">{{ user.username }}'s Profile Image</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                {% if user.profile_picture %}
                    <img src="{{ user.profile_picture.url }}" alt="{{ user.username }}" class="img-fluid rounded" style="max-height: 80vh;">
                {% else %}
                    <img src="{% static 'users/default/df.png' %}" alt="Default Profile" class="img-fluid rounded" style="max-height: 80vh;">
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
    .profile-cover-image {
        height: 200px;
        background: linear-gradient(45deg, var(--primary-color), #ff8f53);
        position: relative;
        overflow: hidden;
        border-top-left-radius: 15px;
        border-top-right-radius: 15px;
    }

    .profile-bg-video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        z-index: 0;
        opacity: 0.5;
    }

    .video-control-btn {
        position: absolute;
        bottom: 10px;
        right: 10px;
        z-index: 2;
        background: rgba(0,0,0,0.6);
        border: none;
        border-radius: 50%;
        color: white;
        padding: 0.5rem 0.7rem;
        font-size: 1.2rem;
        cursor: pointer;
        transition: background 0.3s ease;
    }

    .video-control-btn:hover {
        background: rgba(0,0,0,0.8);
    }
    
    .profile-container {
        max-width: 800px;
        margin: 0 auto;
    }

    .profile-card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        border: none;
        box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        backdrop-filter: blur(10px);
        overflow: hidden;
    }

    .profile-badge {
        position: absolute;
        top: -10px;
        right: 20px;
        background: var(--primary-color);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0 0 10px 10px;
        font-weight: 600;
        animation: slideDown 0.5s ease;
    }

    .profile-picture-section {
        margin-top: -75px;
    }

    .profile-picture-wrapper {
        position: relative;
        display: inline-block;
    }

    .profile-picture {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        border: 5px solid white;
        object-fit: cover;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .stats-container {
        display: flex;
        justify-content: center;
        gap: 2rem;
        margin-top: 2rem;
    }

    .stat-card {
        text-align: center;
        padding: 1rem;
        min-width: 100px;
    }     
    
    .stat-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: #ff4500;
    }
    
    .stat-label {
        font-size: 0.9rem;
        color: #666;
    }

    .action-buttons {
        display: flex;
        gap: 1rem;
        justify-content: center;
        flex-wrap: wrap;
    }

    .feature-card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        border: none;
        box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        backdrop-filter: blur(10px);
    }

    .resume-preview {
        padding: 1rem;
        background: rgba(0,0,0,0.02);
        border-radius: 10px;
        display: flex;
        align-items: center;
    }

    .social-links-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 1rem;
    }

    .social-link-card {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: rgba(0,0,0,0.02);
        border-radius: 10px;
        transition: all 0.3s ease;
    }

    .social-link-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }

    .platform-icon {
        width: 40px;
        height: 40px;
        background: rgba(255,107,53,0.1);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .platform-icon i {
        font-size: 1.5rem;
        color: var(--primary-color);
    }

    .link-details {
        flex: 1;
    }

    .platform-name {
        font-size: 1rem;
        font-weight: 600;
        margin: 0;
    }

    .link-url {
        display: block;
        font-size: 0.9rem;
        color: var(--primary-color);
        text-decoration: none;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 170px;
    }

    .link-stats {
        font-size: 0.8rem;
        color: #666;
        margin-top: 0.5rem;
    }

    @media (max-width: 768px) {
        .profile-container {
            max-width: 100%;
            padding: 0rem;
        }
    
        .profile-card,
        .feature-card {
            padding: 0rem;
        }
    
        .profile-cover-image {
            height: 150px;
        }
    
        .profile-picture-wrapper {
            width: 120px;
            height: 120px;
        }
    
        .profile-picture {
            width: 100%;
            height: 100%;
        }
    
        .profile-badge {
            top: -5px;
            right: 15px;
            font-size: 0.8rem;
            padding: 0.3rem 0.8rem;
        }
    
        .stats-container {
            justify-content: space-between;
            gap: 0;
            width: 100%;
            padding: 0 1rem;
        }
    
        .stat-card {
            background: none;
            padding: 0.5rem;
            min-width: 0;
            box-shadow: none;
        }
    
        .stat-value {
            font-size: 1rem;
        }
    
        .stat-label {
            font-size: 0.8rem;
        }
    
        .action-buttons {
            flex-direction: column;
            align-items: center;
        }
    
        .resume-preview {
            flex-direction: column;
            text-align: center;
        }
    
        .social-links-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 1rem;
        }

        .social-link-card {
            flex-direction: column;
            align-items: normal;
        }
    
        .platform-icon {
            margin-bottom: 0.5rem;
        }
    }
</style>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const video = document.getElementById("introVideo");
        const btn = document.getElementById("playPauseBtn");

        if (video && btn) {
            const icon = btn.querySelector("i");
            btn.addEventListener("click", () => {
                if (video.paused) {
                    video.play();
                    icon.classList.remove("ph-play");
                    icon.classList.add("ph-pause");
                } else {
                    video.pause();
                    icon.classList.remove("ph-pause");
                    icon.classList.add("ph-play");
                }
            });
        }
    });

    // Function to fetch followers count
    function updateFollowersCount() {
        fetch("{% url 'followers_count' user.username %}")
            .then(response => response.json())
            .then(data => {
                const followersBtn = document.querySelector('#followers-btn');
                if (followersBtn) {
                    followersBtn.innerHTML = data.followers_count;
                }
            })
            .catch(err => console.error('Error fetching followers count:', err));
    }
    
    // Function to fetch following count
    function updateFollowingCount() {
        fetch("{% url 'following_count' user.username %}")
            .then(response => response.json())
            .then(data => {
                const followingBtn = document.querySelector('#following-btn');
                if (followingBtn) {
                    followingBtn.innerHTML = data.following_count;
                }
            })
            .catch(err => console.error('Error fetching following count:', err));
    }
    
    // Call the functions periodically
    setInterval(updateFollowersCount, 3000);
    setInterval(updateFollowingCount, 3000);
    
    // Initial call to load data on page load
    updateFollowersCount();
    updateFollowingCount();
</script>
{% endblock %}